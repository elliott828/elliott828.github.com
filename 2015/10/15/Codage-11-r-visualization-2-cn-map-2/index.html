<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="google-site-verification" content="-hIKy4njeS0VoSYzKTofmv6kqKt5CyTP4IVIlIWh1N0" />
<meta name="baidu-site-verification" content="14CLULlEjC" />


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>




  <meta name="keywords" content="R,visualization,ggvis,ggplot2," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="Keep the visualization study, try to realize the following tasks:

Plot one province or multiple provinces
Add labels to capitals
Plot the provincial population based on the latest census
Plot the pro">
<meta property="og:type" content="article">
<meta property="og:title" content="R Visual. - China Map Part II">
<meta property="og:url" content="http://elliott828.github.io/2015/10/15/Codage-11-r-visualization-2-cn-map-2/index.html">
<meta property="og:site_name" content="Exity">
<meta property="og:description" content="Keep the visualization study, try to realize the following tasks:

Plot one province or multiple provinces
Add labels to capitals
Plot the provincial population based on the latest census
Plot the pro">
<meta property="og:image" content="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot1.png">
<meta property="og:image" content="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot2.png">
<meta property="og:image" content="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot3.png">
<meta property="og:image" content="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot4.png">
<meta property="og:image" content="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot5.png">
<meta property="og:image" content="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot6.png">
<meta property="og:image" content="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot7.png">
<meta property="og:image" content="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot8.png">
<meta property="og:updated_time" content="2015-11-13T07:03:17.211Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="R Visual. - China Map Part II">
<meta name="twitter:description" content="Keep the visualization study, try to realize the following tasks:

Plot one province or multiple provinces
Add labels to capitals
Plot the provincial population based on the latest census
Plot the pro">
<meta name="twitter:image" content="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot1.png">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

  <title> R Visual. - China Map Part II | Exity </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', '68396327-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?00cfd9a9530e4098a08a17043202505a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">Exity</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br />
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-next-about"></i> <br />
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
    <div class="site-search">
      
  
  <form class="site-search-form">
    <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
  </form>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'f-s39SMgF52UH9GHejVp','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              R Visual. - China Map Part II
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-10-15T23:34:30+08:00" content="2015-10-15">
            2015-10-15
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/Codage-编程/" itemprop="url" rel="index">
                  <span itemprop="name">Codage|编程</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/10/15/Codage-11-r-visualization-2-cn-map-2/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/10/15/Codage-11-r-visualization-2-cn-map-2/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>Keep the visualization study, try to realize the following tasks:</p>
<ol>
<li>Plot one province or multiple provinces</li>
<li>Add labels to capitals</li>
<li>Plot the provincial population based on the latest census</li>
<li>Plot the provincial population evoluation</li>
<li>Realize the plots above using both <code>ggplot2</code> and <code>ggvis</code></li>
</ol>
<a id="more"></a>
<h2 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h2><p>Load packages and modify local settings in case of Chinese characters not displaying.<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">library</span>(maptools)</div><div class="line"><span class="keyword">library</span>(dplyr)</div><div class="line"><span class="keyword">library</span>(ggplot2)</div><div class="line"><span class="keyword">library</span>(ggvis)</div><div class="line"></div><div class="line">Sys.setlocale(<span class="string">"LC_ALL"</span>, <span class="string">"chinese"</span>)</div></pre></td></tr></table></figure></p>
<h3 id="Raw-Data"><a href="#Raw-Data" class="headerlink" title="Raw Data"></a>Raw Data</h3><p>Subset the polygons with <code>AREA</code> larger than 0.005 and remove the <code>N/A</code>.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cnmap &lt;- readShapePoly(<span class="string">"bou2_4p.shp"</span>)</div><div class="line"><span class="comment"># cnmap@data &lt;- na.omit(cnmap@data)</span></div><div class="line">cnmap@data$ID &lt;- row.names(cnmap@data)</div><div class="line">cnmap &lt;- subset(cnmap, AREA &gt; <span class="number">0.005</span>)</div><div class="line">cnmap@data &lt;- na.omit(cnmap@data)</div></pre></td></tr></table></figure>
<p>Create a <code>data.frame</code> called <code>cnmapdf</code> which contains <code>id</code>, <code>prov_en</code> and <code>prov_cn</code> and key map plotting info:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">prov_cn &lt;- unique(cnmap$NAME)</div><div class="line">prov_en &lt;- c(<span class="string">"Heilongjiang"</span>, <span class="string">"Inner Mongolia"</span>, <span class="string">"Xinjiang"</span>, <span class="string">"Jilin"</span>,</div><div class="line">             <span class="string">"Liaoning"</span>, <span class="string">"Gansu"</span>, <span class="string">"Hebei"</span>, <span class="string">"Beijing"</span>, <span class="string">"Shanxi"</span>,</div><div class="line">             <span class="string">"Tianjin"</span>, <span class="string">"Shaanxi"</span>, <span class="string">"Ningxia"</span>, <span class="string">"Qinghai"</span>, <span class="string">"Shandong"</span>,</div><div class="line">             <span class="string">"Tibet"</span>, <span class="string">"Henan"</span>, <span class="string">"Jiangsu"</span>, <span class="string">"Anhui"</span>, <span class="string">"Sichuan"</span>, <span class="string">"Hubei"</span>,</div><div class="line">             <span class="string">"Chongqing"</span>, <span class="string">"Shanghai"</span>, <span class="string">"Zhejiang"</span>, <span class="string">"Hunan"</span>, <span class="string">"Jiangxi"</span>,</div><div class="line">             <span class="string">"Yunnan"</span>, <span class="string">"Guizhou"</span>, <span class="string">"Fujian"</span>, <span class="string">"Guangxi"</span>, <span class="string">"Taiwan"</span>, </div><div class="line">             <span class="string">"Guangdong"</span>, <span class="string">"Hong Kong"</span>, <span class="string">"Hainan"</span>)</div><div class="line"></div><div class="line">prov &lt;- data.frame(prov_cn, prov_en)</div><div class="line"></div><div class="line">id_prov &lt;- cnmap@data                                               %&gt;%</div><div class="line">  mutate(prov_en = sapply(NAME, </div><div class="line">                          <span class="keyword">function</span>(x)</div><div class="line">                            prov$prov_en[which(prov_cn == x)]))     %&gt;%</div><div class="line">  mutate(prov_cn = as.character(NAME),</div><div class="line">         prov_en = as.character(prov_en))                           %&gt;%</div><div class="line">  select(id = ID, prov_cn, prov_en)</div><div class="line"></div><div class="line"><span class="comment"># you can borrow plyr package in a more efficient way</span></div><div class="line">cnmapdf &lt;- plyr::join(fortify(cnmap), id_prov, by = <span class="string">"id"</span>)</div><div class="line"></div><div class="line"><span class="comment"># head(cnmapdf)</span></div></pre></td></tr></table></figure>
<p>You can also use <code>dplyr</code> to realize the last step, but it is much slower.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cnmapdf &lt;- fortify(cnmap)                                           %&gt;%</div><div class="line">  mutate(prov_en = sapply(id,</div><div class="line">                          <span class="keyword">function</span>(x)id_prov$prov_en[which(id == x)]),</div><div class="line">         prov_cn = sapply(id,</div><div class="line">                          <span class="keyword">function</span>(x)id_prov$prov_cn[which(id == x)]))</div></pre></td></tr></table></figure>
<h3 id="Coordinates-of-Province-Capitals"><a href="#Coordinates-of-Province-Capitals" class="headerlink" title="Coordinates of Province Capitals"></a>Coordinates of Province Capitals</h3><p>Set the capital coordinates of each provinces.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">cap_coord &lt;- c(</div><div class="line">  <span class="string">"Beijing"</span>, <span class="string">"北京"</span>, <span class="string">"Beijing"</span>, <span class="number">116.4666667</span>, <span class="number">39.9</span>,</div><div class="line">  <span class="string">"Shanghai"</span>, <span class="string">"上海"</span>, <span class="string">"Shanghai"</span>, <span class="number">121.4833333</span>, <span class="number">31.23333333</span>,</div><div class="line">  <span class="string">"Tianjin"</span>, <span class="string">"天津"</span>, <span class="string">"Tianjin"</span>, <span class="number">117.1833333</span>, <span class="number">39.15</span>,</div><div class="line">  <span class="string">"Chongqing"</span>, <span class="string">"重庆"</span>, <span class="string">"Chongqing"</span>, <span class="number">106.5333333</span>, <span class="number">29.53333333</span>,</div><div class="line">  <span class="string">"Harbin"</span>, <span class="string">"哈尔滨"</span>, <span class="string">"Heilongjiang"</span>, <span class="number">126.6833333</span>, <span class="number">45.75</span>,</div><div class="line">  <span class="string">"Changchun"</span>, <span class="string">"长春"</span>, <span class="string">"Jilin"</span>, <span class="number">125.3166667</span>, <span class="number">43.86666667</span>,</div><div class="line">  <span class="string">"Shenyang"</span>, <span class="string">"沈阳"</span>, <span class="string">"Liaoning"</span>, <span class="number">123.4</span>, <span class="number">41.83333333</span>,</div><div class="line">  <span class="string">"Hohhot"</span>, <span class="string">"呼和浩特"</span>, <span class="string">"Inner Mongolia"</span>, <span class="number">111.8</span>, <span class="number">40.81666667</span>,</div><div class="line">  <span class="string">"Shijiazhuang"</span>, <span class="string">"石家庄"</span>, <span class="string">"Hebei"</span>, <span class="number">114.4666667</span>, <span class="number">38.03333333</span>,</div><div class="line">  <span class="string">"Taiyuan"</span>, <span class="string">"太原"</span>, <span class="string">"Shanxi"</span>, <span class="number">112.5666667</span>, <span class="number">37.86666667</span>,</div><div class="line">  <span class="string">"Jinan"</span>, <span class="string">"济南"</span>,<span class="string">"Shandong"</span>, <span class="number">117</span>, <span class="number">36.63333333</span>,</div><div class="line">  <span class="string">"Zhengzhou"</span>, <span class="string">"郑州"</span>, <span class="string">"Henan"</span>, <span class="number">113.7</span>, <span class="number">34.8</span>, </div><div class="line">  <span class="string">"Xi'an"</span>, <span class="string">"西安"</span>, <span class="string">"Shaanxi"</span>, <span class="number">108.9</span>, <span class="number">34.26666667</span>,</div><div class="line">  <span class="string">"Lanzhou"</span>, <span class="string">"兰州"</span>, <span class="string">"Gansu"</span>, <span class="number">103.8166667</span>, <span class="number">36.05</span>,</div><div class="line">  <span class="string">"Yinchuan"</span>, <span class="string">"银川"</span>, <span class="string">"Ningxia"</span>, <span class="number">106.2666667</span>, <span class="number">38.33333333</span>,</div><div class="line">  <span class="string">"Xining"</span>, <span class="string">"西宁"</span>, <span class="string">"Qinghai"</span>, <span class="number">101.75</span>, <span class="number">36.63333333</span>,</div><div class="line">  <span class="string">"Urumqi"</span>, <span class="string">"乌鲁木齐"</span>, <span class="string">"Xinjiang"</span>, <span class="number">87.6</span>, <span class="number">43.8</span>,</div><div class="line">  <span class="string">"Hefei"</span>, <span class="string">"合肥"</span>, <span class="string">"Anhui"</span>, <span class="number">117.3</span>, <span class="number">31.85</span>,</div><div class="line">  <span class="string">"Nanjing"</span>, <span class="string">"南京"</span>, <span class="string">"Jiangsu"</span>, <span class="number">118.8333333</span>, <span class="number">32.03333333</span>,</div><div class="line">  <span class="string">"Hangzhou"</span>, <span class="string">"杭州"</span>, <span class="string">"Zhejiang"</span>, <span class="number">120.15</span>, <span class="number">30.23333333</span>,</div><div class="line">  <span class="string">"Changsha"</span>, <span class="string">"长沙"</span>, <span class="string">"Hunan"</span>, <span class="number">113</span>, <span class="number">28.18333333</span>,</div><div class="line">  <span class="string">"Nanchang"</span>, <span class="string">"南昌"</span>, <span class="string">"Jiangxi"</span>, <span class="number">115.8666667</span>, <span class="number">28.68333333</span>,</div><div class="line">  <span class="string">"Wuhan"</span>, <span class="string">"武汉"</span>, <span class="string">"Hubei"</span>, <span class="number">114.35</span>, <span class="number">30.61666667</span>,</div><div class="line">  <span class="string">"Chengdu"</span>, <span class="string">"成都"</span>, <span class="string">"Sichuan"</span>, <span class="number">104.0833333</span>, <span class="number">30.65</span>,</div><div class="line">  <span class="string">"Guiyang"</span>, <span class="string">"贵阳"</span>, <span class="string">"Guizhou"</span>, <span class="number">106.7</span>, <span class="number">26.58333333</span>,</div><div class="line">  <span class="string">"Fuzhou"</span>, <span class="string">"福州"</span>, <span class="string">"Fujian"</span>, <span class="number">119.3</span>, <span class="number">26.08333333</span>,</div><div class="line">  <span class="string">"Taibei"</span>, <span class="string">"台北"</span>, <span class="string">"Taiwan"</span>, <span class="number">121.5166667</span>, <span class="number">25.05</span>,</div><div class="line">  <span class="string">"Guangzhou"</span>, <span class="string">"广州"</span>, <span class="string">"Guangdong"</span>, <span class="number">113.25</span>, <span class="number">23.13333333</span>,</div><div class="line">  <span class="string">"Haikou"</span>, <span class="string">"海口"</span>, <span class="string">"Hainan"</span>, <span class="number">110.3333333</span>, <span class="number">20.03333333</span>,</div><div class="line">  <span class="string">"Nanning"</span>, <span class="string">"南宁"</span>, <span class="string">"Guangxi"</span>, <span class="number">108.3333333</span>, <span class="number">22.8</span>,</div><div class="line">  <span class="string">"Kunming"</span>, <span class="string">"昆明"</span>, <span class="string">"Yunnan"</span>, <span class="number">102.6833333</span>, <span class="number">25</span>,</div><div class="line">  <span class="string">"Lhasa"</span>, <span class="string">"拉萨"</span>, <span class="string">"Tibet"</span>, <span class="number">91.16666667</span>, <span class="number">29.66666667</span>,</div><div class="line">  <span class="string">"Hong Kong"</span>, <span class="string">"香港"</span>, <span class="string">"Hong Kong"</span>, <span class="number">114.1666667</span>, <span class="number">22.3</span>,</div><div class="line">  <span class="string">"Macau"</span>, <span class="string">"澳门"</span>, <span class="string">"Macau"</span>, <span class="number">113.5</span>, <span class="number">22.2</span>)</div><div class="line"></div><div class="line">cap_coord &lt;- as.data.frame(matrix(cap_coord, nrow = <span class="number">34</span>, byrow = <span class="literal">TRUE</span>))</div><div class="line">names(cap_coord) &lt;- c(<span class="string">"city_en"</span>, <span class="string">"city_cn"</span>, <span class="string">"prov_en"</span>, <span class="string">"long"</span>, <span class="string">"lat"</span>)</div><div class="line"></div><div class="line">cap_coord &lt;- cap_coord                                              %&gt;%</div><div class="line">  mutate(prov_en = as.vector(prov_en),</div><div class="line">         city_en = as.vector(city_en),</div><div class="line">         city_cn = as.vector(city_cn),</div><div class="line">         cap_long = as.double(as.vector(long)),</div><div class="line">         cap_lat = as.double(as.vector(lat)))                       %&gt;%</div><div class="line">  select(prov_en, city_en, city_cn, cap_long, cap_lat)</div><div class="line"></div><div class="line"><span class="comment"># cnmapdf &lt;- plyr::join(cnmapdf, cap_coord, by = "prov_en", type = "full")</span></div></pre></td></tr></table></figure>
<h2 id="Plot-Map-for-One-Province"><a href="#Plot-Map-for-One-Province" class="headerlink" title="Plot Map for One Province"></a>Plot Map for One Province</h2><p>Let’s try to plot Shanghai first.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">shanghai &lt;- cnmapdf[cnmapdf$prov_en == <span class="string">"Shanghai"</span>,]</div><div class="line"><span class="comment"># or</span></div><div class="line"><span class="comment"># shanghai &lt;- cnmapdf[prov_cn == "浙江省",]</span></div><div class="line"></div><div class="line">shanghai                                                            %&gt;%</div><div class="line">  ggplot(aes(x = long, y = lat, group = group))                      +</div><div class="line">  geom_polygon(fill = <span class="string">"beige"</span>, color = <span class="string">"grey"</span>)                       +</div><div class="line">  ggtitle(<span class="string">"上海直辖市"</span>)                                              +</div><div class="line">  xlab(<span class="string">"经度"</span>)                                                       +</div><div class="line">  ylab(<span class="string">"维度"</span>)</div></pre></td></tr></table></figure>
<p><img src="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot1.png" alt="vis2-plot1"></p>
<h2 id="Plot-Map-for-Several-Provinces"><a href="#Plot-Map-for-Several-Provinces" class="headerlink" title="Plot Map for Several Provinces"></a>Plot Map for Several Provinces</h2><p>To plot a group of provinces, say Jiangsu, Zhejiang and Shanghai, the Yangtze River Delta.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">map1 &lt;- cnmapdf                                                     %&gt;%</div><div class="line">  filter(prov_en %<span class="keyword">in</span>% c(<span class="string">"Jiangsu"</span>, <span class="string">"Zhejiang"</span>, <span class="string">"Shanghai"</span>))         %&gt;%</div><div class="line">  ggplot()                                                           +</div><div class="line">  geom_polygon(aes(x = long, y = lat, </div><div class="line">                   group = group, fill = prov_cn), </div><div class="line">               color = <span class="string">"grey"</span>)</div><div class="line"></div><div class="line">map1                                                                 +</div><div class="line">  geom_point(x = <span class="number">121.48333</span>, y = <span class="number">31.23333</span>, fill = <span class="string">"beige"</span>)            +</div><div class="line">  geom_point(x = <span class="number">120.15000</span>, y = <span class="number">30.23333</span>, fill = <span class="string">"beige"</span>)            +</div><div class="line">  geom_point(x = <span class="number">118.83333</span>, y = <span class="number">32.03333</span>, fill = <span class="string">"beige"</span>)            +</div><div class="line">  annotate(<span class="string">"text"</span>, x = <span class="number">121.48333</span>, y =  <span class="number">30.93333</span>, label = <span class="string">"上海"</span>)     +</div><div class="line">  annotate(<span class="string">"text"</span>, x = <span class="number">120.15000</span>, y =  <span class="number">29.93333</span>, label = <span class="string">"杭州"</span>)     +</div><div class="line">  annotate(<span class="string">"text"</span>, x = <span class="number">119.13333</span>, y =  <span class="number">32.03333</span>, label = <span class="string">"南京"</span>)     +</div><div class="line">  ggtitle(<span class="string">"长江三角洲"</span>)                                              +</div><div class="line">  xlab(<span class="string">"经度"</span>)                                                       +</div><div class="line">  ylab(<span class="string">"维度"</span>)</div></pre></td></tr></table></figure>
<p><img src="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot2.png" alt="vis2-plot2"></p>
<p>Why do we declare <code>aes()</code> inside <code>geom_polygon()</code> instead of <code>ggplot()</code>? Run the code below and try to move it to the aesthetic mapping in <code>ggplot()</code> and you will find the answer.</p>
<p>It’s apparently a bit complicated using <code>annotate()</code> to add labels to provinces. We can do that this way:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">coord_delta_cap &lt;- subset(cap_coord, prov_en %<span class="keyword">in</span>% c(<span class="string">"Zhejiang"</span>, <span class="string">"Shanghai"</span>, <span class="string">"Jiangsu"</span>))</div><div class="line"></div><div class="line">map1                                                                 +</div><div class="line">  geom_point(data = coord_delta_cap, </div><div class="line">             aes(x = cap_long, y = cap_lat))                         +</div><div class="line">  geom_text(data = coord_delta_cap, </div><div class="line">            aes(cap_long, cap_lat - <span class="number">.25</span>, label = city_cn))           +</div><div class="line">  ggtitle(<span class="string">"长江三角洲"</span>)                                              +</div><div class="line">  xlab(<span class="string">"经度"</span>)                                                       +</div><div class="line">  ylab(<span class="string">"维度"</span>)</div></pre></td></tr></table></figure>
<p><img src="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot3.png" alt="vis2-plot3"></p>
<p>How can we do that via <code>ggvis</code>?<br>In the current version (0.4.2) there is no function like <code>ggplot2::ggtitle()</code> to directly add a title to a <code>ggvis</code> package. So we can define one ourselves.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">add_title &lt;- <span class="keyword">function</span>(vis, <span class="keyword">...</span>, x_lab = <span class="string">""</span>, title = <span class="string">"Plot Title"</span>)&#123;</div><div class="line">  add_axis(vis, <span class="string">"x"</span>, title = x_lab)                                 %&gt;% </div><div class="line">    add_axis(<span class="string">"x"</span>, orient = <span class="string">"top"</span>, ticks = <span class="number">0</span>, title = title,</div><div class="line">             properties = axis_props(</div><div class="line">               axis = list(stroke = <span class="string">"white"</span>),</div><div class="line">               title = list(fontSize = <span class="number">20</span>),</div><div class="line">               labels = list(fontSize = <span class="number">0</span>)</div><div class="line">             ), <span class="keyword">...</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Then apply <code>add_title()</code> to our plot</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">cnmapdf                                                             %&gt;%</div><div class="line">  filter(prov_en %<span class="keyword">in</span>% c(<span class="string">"Jiangsu"</span>, <span class="string">"Zhejiang"</span>, <span class="string">"Shanghai"</span>))         %&gt;%</div><div class="line">  group_by(group)                                                   %&gt;%</div><div class="line">  ggvis(x = ~long, y = ~lat, fill = ~prov_en, stroke := <span class="string">"grey"</span>)     %&gt;%</div><div class="line">  layer_paths()                                                     %&gt;%</div><div class="line">  layer_points(x = ~cap_long, y = ~cap_lat, fill:= <span class="string">"beige"</span>,</div><div class="line">               data = coord_delta_cap)                              %&gt;%</div><div class="line">  layer_text(x = ~cap_long + <span class="number">.2</span>, y = ~cap_lat - <span class="number">.2</span>, </div><div class="line">             stroke := <span class="string">"black"</span>, fontSize := <span class="number">14</span>,</div><div class="line">             text := ~city_en, data = coord_delta_cap)              %&gt;%</div><div class="line">  add_axis(<span class="string">"x"</span>, title = <span class="string">"longtitude"</span>)                               %&gt;%</div><div class="line">  add_axis(<span class="string">"y"</span>, title = <span class="string">"latitude"</span>)                                 %&gt;%</div><div class="line">  add_title(title = <span class="string">"Yangtze River Delta"</span>)</div></pre></td></tr></table></figure>
<p><img src="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot4.png" alt="vis2-plot4"></p>
<h2 id="Combining-Population-Data"><a href="#Combining-Population-Data" class="headerlink" title="Combining Population Data"></a>Combining Population Data</h2><h3 id="Add-Population-Data"><a href="#Add-Population-Data" class="headerlink" title="Add Population Data"></a>Add Population Data</h3><p>Macau is not specified in the raw data, therefore we only plot the other 33 provinces / municipalities / autonomous regions.<br>Population data is scrapped from Wikipedia based on Census. The population Hong Kong and Taiwan are independently collected, so I pick the data in the most adjacent years.<br>You could download the <code>.xlsx</code> raw data <a href="">DemoChinaRaw.xlsx</a> and the <code>.csv</code> cleaned data <a href="">DemoChina.csv</a>.</p>
<p>Need to pay attention to the changes of provinces:</p>
<ul>
<li>Chongqing was a city of Sichuan Province and became a municipality in 1997.</li>
<li>Hainan was a part of Guangdong Province and became an independent province in 1988. This is not reflected in the result of Census in 1990).</li>
<li>From 1949 to now, Tianjin is a municipality but once was a city of Hebei Province between 1958 and 1967.</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">democn &lt;- read.csv(<span class="string">"DemoChina.csv"</span>, stringsAsFactors = <span class="literal">F</span>)</div><div class="line"></div><div class="line"><span class="comment"># check the data per year and per province</span></div><div class="line"><span class="keyword">library</span>(tidyr)</div><div class="line">head(spread(democn, year, population))</div></pre></td></tr></table></figure>
<h3 id="Plot-the-Population-per-Province-by-ggplot"><a href="#Plot-the-Population-per-Province-by-ggplot" class="headerlink" title="Plot the Population per Province by ggplot"></a>Plot the Population per Province by <code>ggplot</code></h3><p>Combine the population from Census in 2010 with map data:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">map2df &lt;- cnmapdf                                                   %&gt;% </div><div class="line">  plyr::join(subset(democn, year == <span class="string">"Census-2010"</span>), by = <span class="string">"prov_en"</span>) %&gt;%</div><div class="line">  mutate(population = as.numeric(population))</div><div class="line"></div><div class="line">map2df                                                              %&gt;%</div><div class="line">  ggplot(aes(x = long, y = lat, group = group, fill = population))   +</div><div class="line">  geom_polygon(color = <span class="string">"grey"</span>)</div></pre></td></tr></table></figure>
<p><img src="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot5.png" alt="vis2-plot5"></p>
<p>To make the heat map by another color scale:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">map2df                                                              %&gt;%</div><div class="line">  ggplot(aes(x = long, y = lat, group = group, fill = population))   +</div><div class="line">  geom_polygon(color = <span class="string">"grey"</span>)                                       +</div><div class="line">  scale_fill_gradient(low = <span class="string">"red"</span>, high = <span class="string">"yellow"</span>)</div></pre></td></tr></table></figure>
<p><img src="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot6.png" alt="vis2-plot6"></p>
<h3 id="Plot-the-Population-per-Province-by-ggvis"><a href="#Plot-the-Population-per-Province-by-ggvis" class="headerlink" title="Plot the Population per Province by ggvis"></a>Plot the Population per Province by <code>ggvis</code></h3><p>Let’s try <code>ggvis</code>:</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">map2df                                                              %&gt;%</div><div class="line">  group_by(group)                                                   %&gt;%</div><div class="line">  ggvis(x = ~long, y = ~lat)                                        %&gt;%</div><div class="line">  layer_paths(fill = ~population, stroke := <span class="string">"grey"</span>)                 %&gt;%</div><div class="line">  scale_numeric(<span class="string">"fill"</span>, range = c(<span class="string">"red"</span>, <span class="string">"yellow"</span>))</div></pre></td></tr></table></figure>
<p><img src="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot7.png" alt="vis2-plot7"></p>
<h3 id="Plot-the-Population-per-Year"><a href="#Plot-the-Population-per-Year" class="headerlink" title="Plot the Population per Year"></a>Plot the Population per Year</h3><p>To check the population evolution per each census by <code>ggplot2</code>.</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">map3df &lt;- cnmapdf                                                   %&gt;% </div><div class="line">  plyr::join(democn, by = <span class="string">"prov_en"</span>)                                %&gt;%</div><div class="line">  mutate(population = as.numeric(population))                       %&gt;%</div><div class="line">  na.omit()</div><div class="line"></div><div class="line">map3df                                                              %&gt;%</div><div class="line">  ggplot(aes(x = long, y = lat, group = group, fill = population))   +</div><div class="line">  geom_polygon(color = <span class="string">"grey"</span>, lwd = <span class="number">.1</span>)                             +</div><div class="line">  coord_equal()                                                      +</div><div class="line">  facet_wrap(~year)</div></pre></td></tr></table></figure>
<p><img src="http://7xndoy.com1.z0.glb.clouddn.com/vis2-plot8.png" alt="vis2-plot8"></p>
<p>Based on the census in 1982 and 1990, the population in Sichuan Province is even higher than in the following years. Should be aware that before the census in 2000, Chongqing is a city of Sichuan. That is how the illusion comes.</p>
<p>It is a shame that <code>ggvis</code> cannot do faceting yet.</p>
<hr>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference:"></a>Reference:</h2><ol>
<li><a href="http://stackoverflow.com/questions/25018598/add-a-plot-title-to-ggvis" target="_blank" rel="external">Add a plot title to ggvis</a></li>
<li><a href="http://spatialanalysis.co.uk/wp-content/uploads/2013/04/james_cheshire_ggplot_intro_blog.pdf" target="_blank" rel="external">Introduction to ggplot2</a></li>
</ol>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/R/" rel="tag">#R</a>
          
            <a href="/tags/visualization/" rel="tag">#visualization</a>
          
            <a href="/tags/ggvis/" rel="tag">#ggvis</a>
          
            <a href="/tags/ggplot2/" rel="tag">#ggplot2</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/10/18/Codage-12-r-visualization-3-bubble-bar-on-map/" rel="prev">R Visual. - Bubbles and Bar Charts on China Map</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/10/11/LaVie-5-suzhou/" rel="next">日行苏州</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
              <div class="ds-thread" data-thread-key="2015/10/15/Codage-11-r-visualization-2-cn-map-2/"
                   data-title="R Visual. - China Map Part II" data-url="http://elliott828.github.io/2015/10/15/Codage-11-r-visualization-2-cn-map-2/">
              </div>
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/uploads/avatar_storm_cat_white.png" alt="Papa Cochon" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Papa Cochon</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">71</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">11</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">96</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name"></p>
            
              <span class="links-of-author-item">
              <a href="http://monkey0105.github.io/" target="_blank">大师兄</a>
              </span>
            
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Preparation"><span class="nav-number">1.</span> <span class="nav-text">Preparation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Raw-Data"><span class="nav-number">1.1.</span> <span class="nav-text">Raw Data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Coordinates-of-Province-Capitals"><span class="nav-number">1.2.</span> <span class="nav-text">Coordinates of Province Capitals</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Plot-Map-for-One-Province"><span class="nav-number">2.</span> <span class="nav-text">Plot Map for One Province</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Plot-Map-for-Several-Provinces"><span class="nav-number">3.</span> <span class="nav-text">Plot Map for Several Provinces</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Combining-Population-Data"><span class="nav-number">4.</span> <span class="nav-text">Combining Population Data</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Add-Population-Data"><span class="nav-number">4.1.</span> <span class="nav-text">Add Population Data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Plot-the-Population-per-Province-by-ggplot"><span class="nav-number">4.2.</span> <span class="nav-text">Plot the Population per Province by ggplot</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Plot-the-Population-per-Province-by-ggvis"><span class="nav-number">4.3.</span> <span class="nav-text">Plot the Population per Province by ggvis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Plot-the-Population-per-Year"><span class="nav-number">4.4.</span> <span class="nav-text">Plot the Population per Year</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">5.</span> <span class="nav-text">Reference:</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Papa Cochon</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

<div class="visit-statistics">
	<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>

	<span id="busuanzi_container_site_pv">
		<span id="busuanzi_value_site_pv"></span> hits from
	</span>
	
	<span id="busuanzi_container_site_uv">
		<span id="busuanzi_value_site_uv"></span> visitors 
	</span>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"papacochon"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     
  	<script src="/js/ua-parser.min.js"></script>
  	<script src="/js/hook-duoshuo.js"></script>
  

    
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>

<!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->

<!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
</body>
</html>
